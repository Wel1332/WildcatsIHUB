{% extends 'adminpanel/base_admin.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="welcome-header">
    <div class="welcome-text">
        <h1>Welcome, Admin!</h1>
        <p class="subtitle">Here's a quick overview of the system.</p>
    </div>
    <div class="user-info">
        <div class="user-avatar">
            <img src="{% if request.user.userprofile.avatar %}{{ request.user.userprofile.avatar.url }}{% else %}{% static 'avatars/default_profile.png' %}{% endif %}" alt="Admin Avatar">
        </div>
        <div class="user-details">
            <span class="user-name">{{ admin_name }}</span>
            <span class="user-role">Administrator</span>
        </div>
    </div>
</div>

<div class="stats">
    <div class="card blue">
        <div class="icon"><i data-lucide="users"></i></div>
        <h2>{{ total_users }}</h2> 
        <p>Total Users</p>
    </div>
    <div class="card green">
        <div class="icon"><i data-lucide="check-circle"></i></div>
        <h2>{{ approved_projects_count }}</h2> 
        <p>Approved Projects</p>
    </div>
    <div class="card purple">
        <div class="icon"><i data-lucide="folder"></i></div>
        <h2>{{ ongoing_projects_count }}</h2>
        <p>Ongoing Projects</p>
    </div>
</div>

<div class="projects-section" style="margin-bottom: 2rem;">
    <div class="section-header">
        <h2>Project Status Overview</h2>
        <p>Real-time breakdown of student submissions.</p>
    </div>
    
    <div style="height: 350px; width: 100%; display: flex; justify-content: center; align-items: center;">
        <canvas id="statusChart"></canvas>
    </div>
</div>

<div class="projects-section">
    <div class="section-header">
        <h2>Recent Activity</h2>
        <p>Latest actions taken by administrators.</p>
    </div>

    {% for project in projects %}
    <div class="project-item status-{{ project.status|lower }}">
        <div class="project-header">
            <div>
                <h3>{{ project.title }}</h3>
                <p style="font-size: 0.9rem; color: #555; margin-top: 5px;">
                    {% if project.approved_by %}
                        <span style="color: #1e5cff; font-weight: 600;">
                            <i class="fas fa-user-shield"></i> {{ project.approved_by.username }}
                        </span> 
                        {{ project.status|lower }} this project on {{ project.approved_at|default:project.created_at|date:"M d, Y" }}
                    {% else %}
                        Submitted by {{ project.author.user.username }} on {{ project.created_at|date:"M d, Y" }}
                    {% endif %}
                </p>
            </div>
            
            <div class="project-status">
                <span class="status-badge {{ project.status|lower }}"> 
                    {{ project.status }}
                </span>
            </div>
        </div>
        
        <div class="project-description">{{ project.description|truncatewords:20 }}</div>
        
        <div class="project-actions" style="margin-top: 15px;">
            <a href="{% url 'project_detail' pk=project.pk %}" class="btn-secondary" style="font-size: 0.85rem;">View Details</a>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <h3>No activity yet</h3>
        <p>Recent actions will appear here.</p>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const ctx = document.getElementById('statusChart').getContext('2d');
        
        // Parse the data safely
        const rawData = '{{ chart_data_json|default:"[]"|escapejs }}';
        const chartData = JSON.parse(rawData);
        
        new Chart(ctx, {
            type: 'doughnut', 
            data: {
                labels: ['Pending', 'Approved', 'Rejected'],
                datasets: [{
                    label: ' Projects',
                    data: chartData,
                    backgroundColor: [
                        '#1e5cff', // Primary Blue (Pending)
                        '#00c853', // Success Green (Approved)
                        '#ff5252'  // Danger Red (Rejected)
                    ],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: { 
                                family: "'Poppins', sans-serif", 
                                size: 12 
                            },
                            usePointStyle: true, 
                        }
                    }
                },
                cutout: '75%', 
            }
        });
    });
</script>

{% endblock %}