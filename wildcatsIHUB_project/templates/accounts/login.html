{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildcats' iHub - Login</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Your custom CSS -->
    <link href="{% static 'css/login.css' %}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<div class="login-card">
    <h2 class="brand-title">Wildcats' iHub</h2>
    <p class="subtitle">Student Project Showcase Platform</p>

    <h4 class="mb-2">Welcome Back</h4>
    <p class="text-muted mb-4">Sign in to your student account</p>

    <!-- Display Django Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <div>
                        <strong class="me-2">Login Failed</strong>
                        {{ message }}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" novalidate id="loginForm">
        {% csrf_token %}

        <div class="mb-3 text-start">
            <label for="id_username" class="form-label">Email</label>
            <div class="input-group">
                <input type="email"
                       name="username"
                       id="id_username"
                       class="form-control {% if form.username.errors or form.non_field_errors %}is-invalid{% endif %}"
                       placeholder="your.email@cit.edu"
                       value="{{ form.username.value|default:'' }}"
                       required
                       data-bs-toggle="tooltip"
                       data-bs-placement="top">
                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
            </div>
            <div class="email-validation text-muted mt-1" id="emailValidation">
                Must be a valid university email address (.edu domain)
            </div>
            {% if form.username.errors %}
                <div class="invalid-feedback d-block" id="emailError">
                    {% for error in form.username.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="mb-3 text-start password-container">
            <label for="id_password" class="form-label">Password</label>
            <div class="input-group">
                <input type="password"
                       name="password"
                       id="id_password"
                       class="form-control {% if form.password.errors or form.non_field_errors %}is-invalid{% endif %}"
                       placeholder="••••••••"
                       required
                       data-bs-toggle="tooltip"
                       data-bs-placement="top">
                <span class="input-group-text toggle-password" id="togglePassword">
                    <i class="far fa-eye"></i>
                </span>
            </div>
            
            {% if form.password.errors %}
                <div class="invalid-feedback d-block" id="passwordError">
                    {% for error in form.password.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="forgot-password mb-3">
            <a href="#" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">
                <i class="fas fa-key me-1"></i>Forgot Password?
            </a>
        </div>

        <button type="submit" class="btn btn-primary w-100" id="submitBtn">
            <i class="fas fa-sign-in-alt me-2"></i>Sign In
        </button>
    </form>

    <p class="footer-link">
        Don't have an account? <a href="{% url 'signup' %}">Create Account</a>
    </p>
</div>

<!-- Forgot Password Modal -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="forgotPasswordModalLabel">Reset Your Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Enter your student email address and we'll send you a link to reset your password.</p>
                <form id="forgotPasswordForm">
                    <div class="mb-3">
                        <label for="resetEmail" class="form-label">Student Email</label>
                        <input type="email" class="form-control" id="resetEmail" 
                               placeholder="your.email@cit.edu"
                               data-bs-toggle="tooltip" data-bs-placement="top">
                        <div class="form-text">Must be your university email address (.edu domain)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendResetLink">
                    <i class="fas fa-paper-plane me-2"></i>Send Reset Link
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'manual'
        });
    });

    // Password visibility toggle
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('id_password');
        const icon = this.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // Form submission validation
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        const email = document.getElementById('id_username').value.trim();
        const password = document.getElementById('id_password').value.trim();
        const emailInput = document.getElementById('id_username');
        const passwordInput = document.getElementById('id_password');
        
        let isValid = true;
        
        // Validate email
        if (!email) {
            const tooltip = bootstrap.Tooltip.getInstance(emailInput);
            tooltip.setContent({'.tooltip-inner': 'Email address is required'});
            tooltip.show();
            emailInput.classList.add('is-invalid');
            isValid = false;
        }
        
        // Validate password
        if (!password) {
            const tooltip = bootstrap.Tooltip.getInstance(passwordInput);
            tooltip.setContent({'.tooltip-inner': 'Password is required'});
            tooltip.show();
            passwordInput.classList.add('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            return;
        }
        
        // Show loading state only if valid
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing In...';
        submitBtn.disabled = true;
    });

    // Email validation for .edu domains
    document.getElementById('id_username').addEventListener('blur', function() {
        const email = this.value;
        const validationText = document.getElementById('emailValidation');
        const emailInput = this;
        
        const studentEmailPattern = /\.edu$/i;
        const isStudentEmail = studentEmailPattern.test(email);
        
        if (email && !isStudentEmail) {
            validationText.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please use a valid .edu email address';
            validationText.className = 'email-validation text-warning';
            
            const tooltip = bootstrap.Tooltip.getInstance(emailInput);
            tooltip.setContent({'.tooltip-inner': 'Email must end with .edu domain'});
            tooltip.show();
        } else if (email && isStudentEmail) {
            validationText.innerHTML = '<i class="fas fa-check-circle"></i> Valid university email';
            validationText.className = 'email-validation text-success';
        } else {
            validationText.innerHTML = 'Must be a valid university email address (.edu domain)';
            validationText.className = 'email-validation text-muted';
        }
    });

    // Clear invalid state when user starts typing
    document.getElementById('id_username').addEventListener('input', function() {
        this.classList.remove('is-invalid');
        const tooltip = bootstrap.Tooltip.getInstance(this);
        if (tooltip) {
            tooltip.hide();
        }
    });

    document.getElementById('id_password').addEventListener('input', function() {
        this.classList.remove('is-invalid');
        const tooltip = bootstrap.Tooltip.getInstance(this);
        if (tooltip) {
            tooltip.hide();
        }
    });

// Forgot password form submission
document.getElementById('sendResetLink').addEventListener('click', function() {
    const email = document.getElementById('resetEmail').value.trim();
    const emailInput = document.getElementById('resetEmail');
    const studentEmailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.edu$/i;
    const sendBtn = this;
    
    // Clear previous states
    emailInput.classList.remove('is-invalid', 'is-valid');
    
    // Get or create tooltip
    let tooltip = bootstrap.Tooltip.getInstance(emailInput);
    if (!tooltip) {
        tooltip = new bootstrap.Tooltip(emailInput, {
            trigger: 'manual',
            placement: 'top'
        });
    }
    tooltip.hide();
    
    // Validate email
    if (!email) {
        emailInput.classList.add('is-invalid');
        tooltip.setContent({'.tooltip-inner': 'Email address is required'});
        tooltip.show();
        return;
    }
    
    if (!studentEmailPattern.test(email)) {
        emailInput.classList.add('is-invalid');
        tooltip.setContent({'.tooltip-inner': 'Please enter a valid .edu email address'});
        tooltip.show();
        return;
    }
    
    // Show loading state
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    sendBtn.disabled = true;
    
    // Send reset password email via Supabase
    console.log("Sending reset request for:", email);
    fetch('/forgot-password/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => {
        console.log("Response status:", response.status);
        return response.json();
    })
    .then(data => {
        console.log("Response data:", data);
        
        // Ensure tooltip exists
        let tooltip = bootstrap.Tooltip.getInstance(emailInput);
        if (!tooltip) {
            tooltip = new bootstrap.Tooltip(emailInput, {
                trigger: 'manual',
                placement: 'top'
            });
        }
        
        if (data.success) {
            // Show success
            emailInput.classList.remove('is-invalid');
            emailInput.classList.add('is-valid');
            tooltip.setContent({'.tooltip-inner': '✅ Password reset link sent!'});
            tooltip.show();
            
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal'));
                modal.hide();
                document.getElementById('resetEmail').value = '';
                emailInput.classList.remove('is-valid');
                tooltip.hide();
            }, 2000);
        } else {
            // Show specific error based on backend response
            emailInput.classList.add('is-invalid');
            
            let errorMessage = data.error;
            if (data.error.includes('not found') || data.error.includes('No account')) {
                errorMessage = 'No account found with this email. Please sign up first.';
            } else if (data.error.includes('valid .edu')) {
                errorMessage = 'Please use a valid .edu email address';
            } else if (data.error.includes('required')) {
                errorMessage = 'Email address is required';
            } else if (data.error.includes('verify')) {
                errorMessage = 'Please verify your email address first';
            } else if (data.error.includes('not allowed')) {
                errorMessage = 'Cannot reset password. Please verify your email first.';
            }
            
            tooltip.setContent({'.tooltip-inner': `❌ ${errorMessage}`});
            tooltip.show();
            
            // Auto-hide tooltip after 5 seconds
            setTimeout(() => {
                tooltip.hide();
            }, 5000);
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        emailInput.classList.add('is-invalid');
        let tooltip = bootstrap.Tooltip.getInstance(emailInput);
        if (!tooltip) {
            tooltip = new bootstrap.Tooltip(emailInput, {
                trigger: 'manual',
                placement: 'top'
            });
        }
        tooltip.setContent({'.tooltip-inner': '❌ Failed to send reset link. Please try again.'});
        tooltip.show();
    })
    .finally(() => {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
    });
});

// Real-time email validation for forgot password
document.getElementById('resetEmail').addEventListener('input', function() {
    const email = this.value.trim();
    const emailInput = this;
    const studentEmailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.edu$/i;
    
    // Clear previous states
    emailInput.classList.remove('is-invalid', 'is-valid');
    const tooltip = bootstrap.Tooltip.getInstance(emailInput);
    if (tooltip) {
        tooltip.hide();
    }
    
    // Validate in real-time
    if (email && studentEmailPattern.test(email)) {
        emailInput.classList.add('is-valid');
    } else if (email) {
        emailInput.classList.add('is-invalid');
    }
});

// Clear validation when modal opens
document.getElementById('forgotPasswordModal').addEventListener('show.bs.modal', function() {
    const emailInput = document.getElementById('resetEmail');
    emailInput.classList.remove('is-invalid', 'is-valid');
    const tooltip = bootstrap.Tooltip.getInstance(emailInput);
    if (tooltip) {
        tooltip.hide();
    }
});

// Clear form when modal closes
document.getElementById('forgotPasswordModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('resetEmail').value = '';
    const emailInput = document.getElementById('resetEmail');
    emailInput.classList.remove('is-invalid', 'is-valid');
    const tooltip = bootstrap.Tooltip.getInstance(emailInput);
    if (tooltip) {
        tooltip.hide();
    }
});

// Clear tooltip on focus
document.querySelectorAll('.form-control').forEach(input => {
    input.addEventListener('focus', function() {
        const tooltip = bootstrap.Tooltip.getInstance(this);
        if (tooltip) {
            tooltip.hide();
        }
    });
});
</script>
</body>
</html>