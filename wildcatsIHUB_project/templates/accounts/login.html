{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildcats' iHub - Login</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Your custom CSS -->
    <link href="{% static 'css/login.css' %}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .back-button-modern {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 1000;
        }
        .back-btn {
            background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%);
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
            color: white;
            background: linear-gradient(135deg, #2980B9 0%, #3498DB 100%);
        }
        .back-btn:active {
            transform: translateY(0);
        }
        .back-btn i {
            transition: transform 0.3s ease;
        }
        .back-btn:hover i {
            transform: translateX(-3px);
        }
        
        /* Floating animation */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .back-btn {
            animation: float 6s ease-in-out infinite;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .back-button-modern {
                position: relative;
                top: auto;
                left: auto;
                margin: 20px auto;
                display: flex;
                justify-content: center;
            }
            .back-btn {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
        
        /* Glass morphism effect */
        .back-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 50px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .back-btn:hover::before {
            opacity: 1;
        }
    </style>
</head>
<body>

<!-- Modern Back Button -->
<div class="back-button-modern">
    <a href="{% url 'landing_page' %}" class="back-btn">
        <i class="fas fa-chevron-left"></i>
        <span>Back to Home</span>
    </a>
</div>

<div class="login-card">
    <h2 class="brand-title">Wildcats' iHub</h2>
    <p class="subtitle">Student Project Showcase Platform</p>

    <h4 class="mb-2">Welcome Back</h4>
    <p class="text-muted mb-4">Sign in to your student account</p>

    <!-- Display Django Messages -->

{% if messages %}
    {% for message in messages %}
        {% if 'success' in message.tags %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    <div>
                        <strong class="me-2">Success!</strong>
                        {{ message }}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% else %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <div>
                        <strong class="me-2">Login Failed</strong>
                        {{ message }}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}
    {% endfor %}
{% endif %}

    <form method="post" novalidate id="loginForm">
        {% csrf_token %}

        <div class="mb-3 text-start">
            <label for="id_username" class="form-label">Email</label>
            <div class="input-group">
                <input type="email"
                       name="username"
                       id="id_username"
                       class="form-control {% if form.username.errors or form.non_field_errors %}is-invalid{% endif %}"
                       placeholder="your.email@cit.edu"
                       value="{{ form.username.value|default:'' }}"
                       required
                       data-bs-toggle="tooltip"
                       data-bs-placement="top">
                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
            </div>
            <div class="email-validation text-muted mt-1" id="emailValidation">
                Must be a valid university email address (.edu domain)
            </div>
            {% if form.username.errors %}
                <div class="invalid-feedback d-block" id="emailError">
                    {% for error in form.username.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="mb-3 text-start password-container">
            <label for="id_password" class="form-label">Password</label>
            <div class="input-group">
                <input type="password"
                       name="password"
                       id="id_password"
                       class="form-control {% if form.password.errors or form.non_field_errors %}is-invalid{% endif %}"
                       placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                       required
                       data-bs-toggle="tooltip"
                       data-bs-placement="top">
                <span class="input-group-text toggle-password" id="togglePassword">
                    <i class="far fa-eye"></i>
                </span>
            </div>
            
            {% if form.password.errors %}
                <div class="invalid-feedback d-block" id="passwordError">
                    {% for error in form.password.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="forgot-password mb-3">
            <a href="#" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">
                <i class="fas fa-key me-1"></i>Forgot Password?
            </a>
        </div>

        <button type="submit" class="btn btn-primary w-100" id="submitBtn">
            <i class="fas fa-sign-in-alt me-2"></i>Sign In
        </button>
    </form>

    <p class="footer-link">
        Don't have an account? <a href="{% url 'signup' %}">Create Account</a>
    </p>
</div>

<!-- Forgot Password Modal -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="forgotPasswordModalLabel">Reset Your Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Enter your student email address and we'll send you a link to reset your password.</p>
                <form id="forgotPasswordForm">
                    <div class="mb-3">
                        <label for="resetEmail" class="form-label">Student Email</label>
                        <input type="email" class="form-control" id="resetEmail" 
                               placeholder="your.email@cit.edu"
                               data-bs-toggle="tooltip" data-bs-placement="top">
                        <div class="form-text">Must be your university email address (.edu domain)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendResetLink">
                    <i class="fas fa-paper-plane me-2"></i>Send Reset Link
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'manual'
        });
    });

    // Password visibility toggle
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('id_password');
        const icon = this.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // Form submission validation
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        const email = document.getElementById('id_username').value.trim();
        const password = document.getElementById('id_password').value.trim();
        const emailInput = document.getElementById('id_username');
        const passwordInput = document.getElementById('id_password');
        
        let isValid = true;
        
        // Validate email
        if (!email) {
            const tooltip = bootstrap.Tooltip.getInstance(emailInput);
            tooltip.setContent({'.tooltip-inner': 'Email address is required'});
            tooltip.show();
            emailInput.classList.add('is-invalid');
            isValid = false;
        }
        
        // Validate password
        if (!password) {
            const tooltip = bootstrap.Tooltip.getInstance(passwordInput);
            tooltip.setContent({'.tooltip-inner': 'Password is required'});
            tooltip.show();
            passwordInput.classList.add('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            return;
        }
        
        // Show loading state only if valid
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing In...';
        submitBtn.disabled = true;
    });

    // Email validation for .edu domains
    document.getElementById('id_username').addEventListener('blur', function() {
        const email = this.value;
        const validationText = document.getElementById('emailValidation');
        const emailInput = this;
        
        const studentEmailPattern = /\.edu$/i;
        const isStudentEmail = studentEmailPattern.test(email);
        
        if (email && !isStudentEmail) {
            validationText.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please use a valid .edu email address';
            validationText.className = 'email-validation text-warning';
            
            const tooltip = bootstrap.Tooltip.getInstance(emailInput);
            tooltip.setContent({'.tooltip-inner': 'Email must end with .edu domain'});
            tooltip.show();
        } else if (email && isStudentEmail) {
            validationText.innerHTML = '<i class="fas fa-check-circle"></i> Valid university email';
            validationText.className = 'email-validation text-success';
        } else {
            validationText.innerHTML = 'Must be a valid university email address (.edu domain)';
            validationText.className = 'email-validation text-muted';
        }
    });

    // Clear invalid state when user starts typing
    document.getElementById('id_username').addEventListener('input', function() {
        this.classList.remove('is-invalid');
        const tooltip = bootstrap.Tooltip.getInstance(this);
        if (tooltip) {
            tooltip.hide();
        }
    });

    document.getElementById('id_password').addEventListener('input', function() {
        this.classList.remove('is-invalid');
        const tooltip = bootstrap.Tooltip.getInstance(this);
        if (tooltip) {
            tooltip.hide();
        }
    });

// Forgot password form submission - Fixed version
document.getElementById('sendResetLink').addEventListener('click', function() {
    const email = document.getElementById('resetEmail').value.trim();
    const emailInput = document.getElementById('resetEmail');
    const studentEmailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.edu$/i;
    const sendBtn = this;
    
    // Clear previous states
    emailInput.classList.remove('is-invalid', 'is-valid');
    
    // Get or create tooltip
    let tooltip = bootstrap.Tooltip.getInstance(emailInput);
    if (!tooltip) {
        tooltip = new bootstrap.Tooltip(emailInput, {
            trigger: 'manual',
            placement: 'top'
        });
    }
    tooltip.hide();
    
    // Validate email
    if (!email) {
        emailInput.classList.add('is-invalid');
        tooltip.setContent({'.tooltip-inner': 'Email address is required'});
        tooltip.show();
        return;
    }
    
    if (!studentEmailPattern.test(email)) {
        emailInput.classList.add('is-invalid');
        tooltip.setContent({'.tooltip-inner': 'Please enter a valid .edu email address'});
        tooltip.show();
        return;
    }
    
    // Show loading state
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    sendBtn.disabled = true;
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Enhanced fetch with better error handling
    fetch('{% url "forgot_password" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => {
        console.log("Response status:", response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log("Password reset response:", data);
        
        // Ensure tooltip exists
        let tooltip = bootstrap.Tooltip.getInstance(emailInput);
        if (!tooltip) {
            tooltip = new bootstrap.Tooltip(emailInput, {
                trigger: 'manual',
                placement: 'top'
            });
        }
        
        if (data.success) {
            // Show success
            emailInput.classList.remove('is-invalid');
            emailInput.classList.add('is-valid');
            tooltip.setContent({'.tooltip-inner': 'âœ… ' + data.message});
            tooltip.show();
            
            // Close modal after success
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Reset form
                document.getElementById('resetEmail').value = '';
                emailInput.classList.remove('is-valid');
                tooltip.hide();
                
                // Show success message
                alert('ðŸ“§ ' + data.message + '\n\nPlease check your Outlook student email (including spam folder).');
            }, 3000);
        } else {
            // Enhanced error handling
            emailInput.classList.add('is-invalid');
            
            let errorMessage = data.error || 'Unknown error occurred';
            
            // Map specific backend errors to user-friendly messages
            const errorMap = {
                'not found': 'No student account found with this email. Please sign up first.',
                'no account': 'No student account found with this email. Please sign up first.',
                'valid .edu': 'Please use a valid .edu email address',
                'required': 'Email address is required',
                'verify': 'Please verify your email address first. Check your inbox/spam for verification link.',
                'not allowed': 'Cannot reset password. Please verify your email first.',
                'rate limit': 'Too many attempts. Please wait 5 minutes and try again.',
                'email delivery': 'Email service temporarily unavailable. Please try again in 2 minutes.',
                'system error': 'System error. Please try again.'
            };
            
            for (const [key, message] of Object.entries(errorMap)) {
                if (data.error.toLowerCase().includes(key.toLowerCase())) {
                    errorMessage = message;
                    break;
                }
            }
            
            tooltip.setContent({'.tooltip-inner': 'âŒ ' + errorMessage});
            tooltip.show();
            
            // Auto-hide tooltip after 5 seconds
            setTimeout(() => {
                tooltip.hide();
            }, 5000);
        }
    })
    .catch(error => {
        console.error('Password reset error:', error);
        emailInput.classList.add('is-invalid');
        
        let tooltip = bootstrap.Tooltip.getInstance(emailInput);
        if (!tooltip) {
            tooltip = new bootstrap.Tooltip(emailInput, {
                trigger: 'manual',
                placement: 'top'
            });
        }
        
        let errorMessage = 'Network error. Please check your connection and try again.';
        if (error.message.includes('Failed to fetch')) {
            errorMessage = 'Network connection failed. Please check your internet connection.';
        }
        
        tooltip.setContent({'.tooltip-inner': 'âŒ ' + errorMessage});
        tooltip.show();
    })
    .finally(() => {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
    });
});


// Real-time email validation for forgot password
document.getElementById('resetEmail').addEventListener('input', function() {
    const email = this.value.trim();
    const emailInput = this;
    const studentEmailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.edu$/i;
    
    // Clear previous states
    emailInput.classList.remove('is-invalid', 'is-valid');
    const tooltip = bootstrap.Tooltip.getInstance(emailInput);
    if (tooltip) {
        tooltip.hide();
    }
    
    // Validate in real-time
    if (email && studentEmailPattern.test(email)) {
        emailInput.classList.add('is-valid');
    } else if (email) {
        emailInput.classList.add('is-invalid');
    }
});

// Clear validation when modal opens
document.getElementById('forgotPasswordModal').addEventListener('show.bs.modal', function() {
    const emailInput = document.getElementById('resetEmail');
    emailInput.classList.remove('is-invalid', 'is-valid');
    const tooltip = bootstrap.Tooltip.getInstance(emailInput);
    if (tooltip) {
        tooltip.hide();
    }
});

// Clear form when modal closes
document.getElementById('forgotPasswordModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('resetEmail').value = '';
    const emailInput = document.getElementById('resetEmail');
    emailInput.classList.remove('is-invalid', 'is-valid');
    const tooltip = bootstrap.Tooltip.getInstance(emailInput);
    if (tooltip) {
        tooltip.hide();
    }
});

// Clear tooltip on focus
document.querySelectorAll('.form-control').forEach(input => {
    input.addEventListener('focus', function() {
        const tooltip = bootstrap.Tooltip.getInstance(this);
        if (tooltip) {
            tooltip.hide();
        }
    });
});
</script>
</body>
</html>