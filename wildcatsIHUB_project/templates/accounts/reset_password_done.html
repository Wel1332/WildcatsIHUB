def reset_password_done(request):
    """Handle the actual password reset"""
    if request.method == 'POST':
        token = request.POST.get('token')
        new_password = request.POST.get('new_password')
        confirm_password = request.POST.get('confirm_password')
        
        print(f"ðŸ”§ DEBUG: Password reset attempt - token: {token}")
        print(f"ðŸ”§ DEBUG: Token length: {len(token) if token else 0}")
        
        if new_password != confirm_password:
            messages.error(request, 'Passwords do not match.')
            return render(request, 'accounts/reset_password_confirm.html')
        
        if len(new_password) < 6:
            messages.error(request, 'Password must be at least 6 characters long.')
            return render(request, 'accounts/reset_password_confirm.html')
        
        supabase = create_client(
            os.getenv('SUPABASE_URL'),
            os.getenv('SUPABASE_KEY')
        )
        
        try:
            # **METHOD 1: Use the token to set session and then update password**
            print("ðŸ”„ DEBUG: Trying METHOD 1 - set_session with token")
            
            # For JWT tokens, we need to create a session first
            # The token from Supabase email is an access_token that can be used to set session
            session_response = supabase.auth.set_session(token)
            
            if hasattr(session_response, 'error') and session_response.error:
                error_msg = str(session_response.error)
                print(f"ðŸ”§ DEBUG: set_session failed: {error_msg}")
                raise Exception(f"Session creation failed: {error_msg}")
            
            # Now update the password with the active session
            update_response = supabase.auth.update_user({
                "password": new_password
            })
            
            if hasattr(update_response, 'error') and update_response.error:
                error_msg = str(update_response.error)
                print(f"ðŸ”§ DEBUG: Password update error: {error_msg}")
                raise Exception(f"Password update failed: {error_msg}")
            
            print(f"âœ… DEBUG: Password reset successful via METHOD 1")
            messages.success(request, 'Password reset successfully! You can now login with your new password.')
            
            # Sign out after password reset
            supabase.auth.sign_out()
                
            return redirect('login')
            
        except Exception as e:
            print(f"ðŸ”§ DEBUG: Password reset exception: {e}")
            messages.error(request, f'Password reset failed: {str(e)}')
            return render(request, 'accounts/reset_password_confirm.html')
    
    # If not POST, redirect to the form page
    return redirect('reset_password_confirm')