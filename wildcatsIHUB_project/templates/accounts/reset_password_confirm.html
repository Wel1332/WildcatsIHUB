{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildcats' iHub - Reset Password</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/reset-password.css' %}">
</head>
<body>
    <div class="container">
        <h1 class="brand">Wildcats' iHub</h1>
        <p class="subtitle">Student Project Showcase Platform</p>

        <!-- Display Messages -->
        {% if messages %}
            {% for message in messages %}
                {% if 'success' in message.tags %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle me-2"></i>
                            <div>
                                <strong>Success!</strong> {{ message }}
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% else %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <div>
                                <strong>Error:</strong> {{ message }}
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}

        <div class="card">
            <h2>Reset Password</h2>
            <p class="description">Enter your new password below</p>

            <!-- Password Reset Form -->
            <form method="POST" action="{% url 'reset_password_done' %}" class="reset-form" id="resetPasswordForm">
                {% csrf_token %}
                
                <!-- Hidden token field -->
                <input type="hidden" name="token" id="resetToken">
                
                <div class="field">
                    <label for="new_password" class="password-hint">
                        New Password
                        <span class="password-hint-trigger" 
                              data-bs-toggle="tooltip" 
                              data-bs-html="true"
                              data-bs-title="<strong>Password Requirements:</strong><br>‚Ä¢ At least 8 characters<br>‚Ä¢ One uppercase letter<br>‚Ä¢ One lowercase letter<br>‚Ä¢ One number<br>‚Ä¢ One special character">
                            <i class="fas fa-question-circle"></i>
                        </span>
                    </label>
                    <div class="password-container">
                        <input 
                            type="password" 
                            name="new_password" 
                            id="new_password" 
                            class="form-control" 
                            placeholder="Enter your new password" 
                            required
                            minlength="8"
                        >
                        <span class="toggle-password" id="toggleNewPassword">
                            <i class="far fa-eye"></i>
                        </span>
                    </div>
                    <div class="validation-message text-danger" id="passwordError" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> Password does not meet requirements
                    </div>
                    <div class="password-requirements">
                        <small class="text-muted">
                            <strong>Password must contain:</strong><br>
                            <span id="lengthReq" class="text-danger"><i class="fas fa-times-circle"></i> At least 8 characters</span><br>
                            <span id="upperReq" class="text-danger"><i class="fas fa-times-circle"></i> One uppercase letter</span><br>
                            <span id="lowerReq" class="text-danger"><i class="fas fa-times-circle"></i> One lowercase letter</span><br>
                            <span id="numberReq" class="text-danger"><i class="fas fa-times-circle"></i> One number</span><br>
                            <span id="specialReq" class="text-danger"><i class="fas fa-times-circle"></i> One special character</span>
                        </small>
                    </div>
                </div>

                <div class="field">
                    <label for="confirm_password">Confirm New Password</label>
                    <div class="password-container">
                        <input 
                            type="password" 
                            name="confirm_password" 
                            id="confirm_password" 
                            class="form-control" 
                            placeholder="Confirm your new password" 
                            required
                            minlength="8"
                        >
                        <span class="toggle-password" id="toggleConfirmPassword">
                            <i class="far fa-eye"></i>
                        </span>
                    </div>
                    <div class="validation-message text-success" id="passwordMatch" style="display: none;">
                        <i class="fas fa-check-circle"></i> Passwords match
                    </div>
                    <div class="validation-message text-danger" id="passwordMismatch" style="display: none;">
                        <i class="fas fa-times-circle"></i> Passwords do not match
                    </div>
                </div>

                <button type="submit" class="btn" id="submitBtn">
                    <i class="fas fa-key me-2"></i>Reset Password
                </button>
            </form>

            <p class="footer">
                Remember your password?
                <a href="{% url 'login' %}">Back to Login</a>
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Extract token from URL hash
        function extractTokenFromUrl() {
            console.log('üîß DEBUG: Extracting token from URL...');
            console.log('üîß DEBUG: Full URL:', window.location.href);
            console.log('üîß DEBUG: URL hash:', window.location.hash);

            // Check URL hash (Supabase puts token here)
            const hash = window.location.hash;
            if (hash) {
                console.log('üîß DEBUG: Processing hash:', hash);
                const hashParams = new URLSearchParams(hash.substring(1));
                
                // Get the access_token from hash
                const accessToken = hashParams.get('access_token');
                
                if (accessToken) {
                    console.log('‚úÖ DEBUG: Access token found in URL hash:', accessToken.substring(0, 50) + '...');
                    document.getElementById('resetToken').value = accessToken;
                    return accessToken;
                } else {
                    console.log('üîß DEBUG: Available hash parameters:');
                    for (let [key, value] of hashParams.entries()) {
                        console.log(`  ${key}: ${value ? value.substring(0, 20) + '...' : 'null'}`);
                    }
                }
            }

            console.warn('‚ùå DEBUG: No access_token found in URL hash');
            return null;
        }

        // Password validation functions
        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                upper: /[A-Z]/.test(password),
                lower: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };
            
            // Update requirement indicators
            document.getElementById('lengthReq').className = requirements.length ? 'text-success' : 'text-danger';
            document.getElementById('lengthReq').innerHTML = (requirements.length ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>') + ' At least 8 characters';
            
            document.getElementById('upperReq').className = requirements.upper ? 'text-success' : 'text-danger';
            document.getElementById('upperReq').innerHTML = (requirements.upper ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>') + ' One uppercase letter';
            
            document.getElementById('lowerReq').className = requirements.lower ? 'text-success' : 'text-danger';
            document.getElementById('lowerReq').innerHTML = (requirements.lower ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>') + ' One lowercase letter';
            
            document.getElementById('numberReq').className = requirements.number ? 'text-success' : 'text-danger';
            document.getElementById('numberReq').innerHTML = (requirements.number ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>') + ' One number';
            
            document.getElementById('specialReq').className = requirements.special ? 'text-success' : 'text-danger';
            document.getElementById('specialReq').innerHTML = (requirements.special ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>') + ' One special character';
            
            // Show/hide error message
            const passwordError = document.getElementById('passwordError');
            const allValid = Object.values(requirements).every(req => req);
            
            if (password.length > 0 && !allValid) {
                passwordError.style.display = 'block';
            } else {
                passwordError.style.display = 'none';
            }
            
            return allValid;
        }

        function validatePasswords() {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const matchElement = document.getElementById('passwordMatch');
            const mismatchElement = document.getElementById('passwordMismatch');
            const submitBtn = document.getElementById('submitBtn');

            // Validate password requirements
            const passwordValid = validatePassword(newPassword);
            
            // Validate password match
            if (confirmPassword.length === 0) {
                matchElement.style.display = 'none';
                mismatchElement.style.display = 'none';
                submitBtn.disabled = true;
                return;
            }

            if (newPassword === confirmPassword && passwordValid) {
                matchElement.style.display = 'block';
                mismatchElement.style.display = 'none';
                submitBtn.disabled = false;
            } else {
                matchElement.style.display = 'none';
                if (confirmPassword.length > 0) {
                    mismatchElement.style.display = 'block';
                }
                submitBtn.disabled = true;
            }
        }

        // Password visibility toggle
        function setupPasswordToggle() {
            // New password toggle
            document.getElementById('toggleNewPassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('new_password');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            // Confirm password toggle
            document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('confirm_password');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        }

        // Form submission handler
        document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
            const token = document.getElementById('resetToken').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (!token) {
                e.preventDefault();
                alert('‚ùå Invalid reset link. Please request a new password reset.');
                return;
            }

            if (newPassword !== confirmPassword) {
                e.preventDefault();
                alert('‚ùå Passwords do not match. Please check and try again.');
                return;
            }

            if (!validatePassword(newPassword)) {
                e.preventDefault();
                alert('‚ùå Password does not meet all requirements.');
                return;
            }

            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting Password...';
            
            console.log('‚úÖ DEBUG: Form submitted with token:', token.substring(0, 50) + '...');
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Reset password page loaded');
            
            // Initialize Bootstrap tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const token = extractTokenFromUrl();
            
            if (!token) {
                // If no token found, show error and disable form
                const card = document.querySelector('.card');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger alert-dismissible fade show';
                errorDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <div>
                            <strong>Invalid Reset Link:</strong> This reset link is invalid or has expired. Please request a new password reset.
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                card.insertBefore(errorDiv, card.querySelector('form'));
                
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').innerHTML = '<i class="fas fa-ban me-2"></i>Invalid Reset Link';
            } else {
                console.log('‚úÖ Token successfully extracted and form is ready');
            }

            // Setup password toggles
            setupPasswordToggle();

            // Add event listeners for password validation
            document.getElementById('new_password').addEventListener('input', validatePasswords);
            document.getElementById('confirm_password').addEventListener('input', validatePasswords);
            
            // Initial validation
            validatePasswords();
        });
    </script>
</body>
</html>